(begin
  
  (bench "streams - answers" 100
	 ;; Tests the speed at which we assemble our answer stream if there are no freshes to check for unnecessary suspension.
	 (run* (x)
	   (let recur ([n 10])
	     (if (fx= 0 n) (== 1 1)
		 (conde [(recur (fx- n 1))]
			[(recur (fx- n 1))])))))

  (bench "streams - mplus" 100
	 ;; Pure interleaving speed
	 (run* (x)
	   (let recur ([n 10])
	     (fresh (x)
	       (if (fx= 0 n) (== 1 1)
		   (conde [(recur (fx- n 1))]
			  [(recur (fx- n 1))]))))))

  (bench "variable - creation" 1000
	 ;; Pure variable instantiation speed
	 (run* (x)
	   (fresh (x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11 x12 x13 x14 x15 x16 x17 x18 x19 x20 x21 x22 x23 x24 x25 x26 x27 x28 x29 x30 x31 x32 x33 x34 x35 x36 x37 x38 x39 x40 x41 x42 x43 x44 x45 x46 x47 x48 x49 x50 x51 x52 x53 x54 x55 x56 x57 x58 x59 x60 x61 x62 x63 x64 x65 x66 x67 x68 x69 x70 x71 x72 x73 x74 x75 x76 x77 x78 x79 x80 x81 x82 x83 x84 x85 x86 x87 x88 x89 x90 x91 x92 x93 x94 x95 x96 x97 x98 x99 x100) (== 1 1))))

  (bench "substitution - extend" 150
	 ;; Extending the substitution
	 (run* (x)
	   (let loop ([n 5])
	     (if (fx= n 0) (== 1 1)
		 (fresh (x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11 x12 x13 x14 x15 x16 x17 x18 x19 x20 x21 x22 x23 x24 x25 x26 x27 x28 x29 x30 x31 x32 x33 x34 x35 x36 x37 x38 x39 x40 x41 x42 x43 x44 x45 x46 x47 x48 x49 x50 x51 x52 x53 x54 x55 x56 x57 x58 x59 x60 x61 x62 x63 x64 x65 x66 x67 x68 x69 x70 x71 x72 x73 x74 x75 x76 x77 x78 x79 x80 x81 x82 x83 x84 x85 x86 x87 x88 x89 x90 x91 x92 x93 x94 x95 x96 x97 x98 x99 x100)
		   (conde [(== x1 1) (== x2 1) (== x3 1) (== x4 1) (== x5 1) (== x6 1) (== x7 1) (== x8 1) (== x9 1) (== x10 1) (== x11 1) (== x12 1) (== x13 1) (== x14 1) (== x15 1) (== x16 1) (== x17 1) (== x18 1) (== x19 1) (== x20 1) (== x21 1) (== x22 1) (== x23 1) (== x24 1) (== x25 1) (== x26 1) (== x27 1) (== x28 1) (== x29 1) (== x30 1) (== x31 1) (== x32 1) (== x33 1) (== x34 1) (== x35 1) (== x36 1) (== x37 1) (== x38 1) (== x39 1) (== x40 1) (== x41 1) (== x42 1) (== x43 1) (== x44 1) (== x45 1) (== x46 1) (== x47 1) (== x48 1) (== x49 1) (== x50 1) (== x51 1) (== x52 1) (== x53 1) (== x54 1) (== x55 1) (== x56 1) (== x57 1) (== x58 1) (== x59 1) (== x60 1) (== x61 1) (== x62 1) (== x63 1) (== x64 1) (== x65 1) (== x66 1) (== x67 1) (== x68 1) (== x69 1) (== x70 1) (== x71 1) (== x72 1) (== x73 1) (== x74 1) (== x75 1) (== x76 1) (== x77 1) (== x78 1) (== x79 1) (== x80 1) (== x81 1) (== x82 1) (== x83 1) (== x84 1) (== x85 1) (== x86 1) (== x87 1) (== x88 1) (== x89 1) (== x90 1) (== x91 1) (== x92 1) (== x93 1) (== x94 1) (== x95 1) (== x96 1) (== x97 1) (== x98 1) (== x99 1) (== x100 1) (loop (fx- n 1))] ; Hide extension in a conj to avoid optimizations that skip substitution
			  [(== x1 1) (== x2 1) (== x3 1) (== x4 1) (== x5 1) (== x6 1) (== x7 1) (== x8 1) (== x9 1) (== x10 1) (== x11 1) (== x12 1) (== x13 1) (== x14 1) (== x15 1) (== x16 1) (== x17 1) (== x18 1) (== x19 1) (== x20 1) (== x21 1) (== x22 1) (== x23 1) (== x24 1) (== x25 1) (== x26 1) (== x27 1) (== x28 1) (== x29 1) (== x30 1) (== x31 1) (== x32 1) (== x33 1) (== x34 1) (== x35 1) (== x36 1) (== x37 1) (== x38 1) (== x39 1) (== x40 1) (== x41 1) (== x42 1) (== x43 1) (== x44 1) (== x45 1) (== x46 1) (== x47 1) (== x48 1) (== x49 1) (== x50 1) (== x51 1) (== x52 1) (== x53 1) (== x54 1) (== x55 1) (== x56 1) (== x57 1) (== x58 1) (== x59 1) (== x60 1) (== x61 1) (== x62 1) (== x63 1) (== x64 1) (== x65 1) (== x66 1) (== x67 1) (== x68 1) (== x69 1) (== x70 1) (== x71 1) (== x72 1) (== x73 1) (== x74 1) (== x75 1) (== x76 1) (== x77 1) (== x78 1) (== x79 1) (== x80 1) (== x81 1) (== x82 1) (== x83 1) (== x84 1) (== x85 1) (== x86 1) (== x87 1) (== x88 1) (== x89 1) (== x90 1) (== x91 1) (== x92 1) (== x93 1) (== x94 1) (== x95 1) (== x96 1) (== x97 1) (== x98 1) (== x99 1) (== x100 1) (loop (fx- n 1))]))))))

  (bench "substitution - ground" 2000
	 ;; Simple unification with ground terms. Values that will always be constant (unified between creation and conde) should be optimized away and never hit the substitution.
	 (run* (x)
	   (let loop ([n 5])
	     (if (fx= n 0) (== 1 1)
		 (fresh (x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11 x12 x13 x14 x15 x16 x17 x18 x19 x20 x21 x22 x23 x24 x25 x26 x27 x28 x29 x30 x31 x32 x33 x34 x35 x36 x37 x38 x39 x40 x41 x42 x43 x44 x45 x46 x47 x48 x49 x50 x51 x52 x53 x54 x55 x56 x57 x58 x59 x60 x61 x62 x63 x64 x65 x66 x67 x68 x69 x70 x71 x72 x73 x74 x75 x76 x77 x78 x79 x80 x81 x82 x83 x84 x85 x86 x87 x88 x89 x90 x91 x92 x93 x94 x95 x96 x97 x98 x99 x100)
		   (== x1 1) (== x2 1) (== x3 1) (== x4 1) (== x5 1) (== x6 1) (== x7 1) (== x8 1) (== x9 1) (== x10 1) (== x11 1) (== x12 1) (== x13 1) (== x14 1) (== x15 1) (== x16 1) (== x17 1) (== x18 1) (== x19 1) (== x20 1) (== x21 1) (== x22 1) (== x23 1) (== x24 1) (== x25 1) (== x26 1) (== x27 1) (== x28 1) (== x29 1) (== x30 1) (== x31 1) (== x32 1) (== x33 1) (== x34 1) (== x35 1) (== x36 1) (== x37 1) (== x38 1) (== x39 1) (== x40 1) (== x41 1) (== x42 1) (== x43 1) (== x44 1) (== x45 1) (== x46 1) (== x47 1) (== x48 1) (== x49 1) (== x50 1) (== x51 1) (== x52 1) (== x53 1) (== x54 1) (== x55 1) (== x56 1) (== x57 1) (== x58 1) (== x59 1) (== x60 1) (== x61 1) (== x62 1) (== x63 1) (== x64 1) (== x65 1) (== x66 1) (== x67 1) (== x68 1) (== x69 1) (== x70 1) (== x71 1) (== x72 1) (== x73 1) (== x74 1) (== x75 1) (== x76 1) (== x77 1) (== x78 1) (== x79 1) (== x80 1) (== x81 1) (== x82 1) (== x83 1) (== x84 1) (== x85 1) (== x86 1) (== x87 1) (== x88 1) (== x89 1) (== x90 1) (== x91 1) (== x92 1) (== x93 1) (== x94 1) (== x95 1) (== x96 1) (== x97 1) (== x98 1) (== x99 1) (== x100 1) (loop (fx- n 1)))))))

  (bench "substitution - lookup earliest" 100
	 ;; Extending the substitution and referencing the first bound variable. Skew binary random access lists have O(log(n)) for accessing the earliest element.
	 (run 1 (x)
	       (fresh (x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11 x12 x13 x14 x15 x16 x17 x18 x19 x20 x21 x22 x23 x24 x25 x26 x27 x28 x29 x30 x31 x32 x33 x34 x35 x36 x37 x38 x39 x40 x41 x42 x43 x44 x45 x46 x47 x48 x49 x50 x51 x52 x53 x54 x55 x56 x57 x58 x59 x60 x61 x62 x63 x64 x65 x66 x67 x68 x69 x70 x71 x72 x73 x74 x75 x76 x77 x78 x79 x80 x81 x82 x83 x84 x85 x86 x87 x88 x89 x90 x91 x92 x93 x94 x95 x96 x97 x98 x99 x100)
		 (conde [(== x1 x2) (== x2 x3) (== x3 x4) (== x4 x5) (== x5 x6) (== x6 x7) (== x7 x8) (== x8 x9) (== x9 x10) (== x10 x11) (== x11 x12) (== x12 x13) (== x13 x14) (== x14 x15) (== x15 x16) (== x16 x17) (== x17 x18) (== x18 x19) (== x19 x20) (== x20 x21) (== x21 x22) (== x22 x23) (== x23 x24) (== x24 x25) (== x25 x26) (== x26 x27) (== x27 x28) (== x28 x29) (== x29 x30) (== x30 x31) (== x31 x32) (== x32 x33) (== x33 x34) (== x34 x35) (== x35 x36) (== x36 x37) (== x37 x38) (== x38 x39) (== x39 x40) (== x40 x41) (== x41 x42) (== x42 x43) (== x43 x44) (== x44 x45) (== x45 x46) (== x46 x47) (== x47 x48) (== x48 x49) (== x49 x50) (== x50 x51) (== x51 x52) (== x52 x53) (== x53 x54) (== x54 x55) (== x55 x56) (== x56 x57) (== x57 x58) (== x58 x59) (== x59 x60) (== x60 x61) (== x61 x62) (== x62 x63) (== x63 x64) (== x64 x65) (== x65 x66) (== x66 x67) (== x67 x68) (== x68 x69) (== x69 x70) (== x70 x71) (== x71 x72) (== x72 x73) (== x73 x74) (== x74 x75) (== x75 x76) (== x76 x77) (== x77 x78) (== x78 x79) (== x79 x80) (== x80 x81) (== x81 x82) (== x82 x83) (== x83 x84) (== x84 x85) (== x85 x86) (== x86 x87) (== x87 x88) (== x88 x89) (== x89 x90) (== x90 x91) (== x91 x92) (== x92 x93) (== x93 x94) (== x94 x95) (== x95 x96) (== x96 x97) (== x97 x98) (== x98 x99) (== x99 x100)
			 (== (list x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1 x1)
			     (list 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100))]
			[(== 1 2)]))))

  (bench "substitution - lookup latest" 150
	 ;; Extending the substitution and referencing the most recent variable. Skew binary random access lists have O(1) for accessing the most recent element.
	 (run 1 (x)
	       (fresh (x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11 x12 x13 x14 x15 x16 x17 x18 x19 x20 x21 x22 x23 x24 x25 x26 x27 x28 x29 x30 x31 x32 x33 x34 x35 x36 x37 x38 x39 x40 x41 x42 x43 x44 x45 x46 x47 x48 x49 x50 x51 x52 x53 x54 x55 x56 x57 x58 x59 x60 x61 x62 x63 x64 x65 x66 x67 x68 x69 x70 x71 x72 x73 x74 x75 x76 x77 x78 x79 x80 x81 x82 x83 x84 x85 x86 x87 x88 x89 x90 x91 x92 x93 x94 x95 x96 x97 x98 x99 x100)
		 (conde [(== x1 x2) (== x2 x3) (== x3 x4) (== x4 x5) (== x5 x6) (== x6 x7) (== x7 x8) (== x8 x9) (== x9 x10) (== x10 x11) (== x11 x12) (== x12 x13) (== x13 x14) (== x14 x15) (== x15 x16) (== x16 x17) (== x17 x18) (== x18 x19) (== x19 x20) (== x20 x21) (== x21 x22) (== x22 x23) (== x23 x24) (== x24 x25) (== x25 x26) (== x26 x27) (== x27 x28) (== x28 x29) (== x29 x30) (== x30 x31) (== x31 x32) (== x32 x33) (== x33 x34) (== x34 x35) (== x35 x36) (== x36 x37) (== x37 x38) (== x38 x39) (== x39 x40) (== x40 x41) (== x41 x42) (== x42 x43) (== x43 x44) (== x44 x45) (== x45 x46) (== x46 x47) (== x47 x48) (== x48 x49) (== x49 x50) (== x50 x51) (== x51 x52) (== x52 x53) (== x53 x54) (== x54 x55) (== x55 x56) (== x56 x57) (== x57 x58) (== x58 x59) (== x59 x60) (== x60 x61) (== x61 x62) (== x62 x63) (== x63 x64) (== x64 x65) (== x65 x66) (== x66 x67) (== x67 x68) (== x68 x69) (== x69 x70) (== x70 x71) (== x71 x72) (== x72 x73) (== x73 x74) (== x74 x75) (== x75 x76) (== x76 x77) (== x77 x78) (== x78 x79) (== x79 x80) (== x80 x81) (== x81 x82) (== x82 x83) (== x83 x84) (== x84 x85) (== x85 x86) (== x86 x87) (== x87 x88) (== x88 x89) (== x89 x90) (== x90 x91) (== x91 x92) (== x92 x93) (== x93 x94) (== x94 x95) (== x95 x96) (== x96 x97) (== x97 x98) (== x98 x99) (== x99 x100)
			 (== (list x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100 x100)
			     (list 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100))]
			[(== 1 2)])))))
